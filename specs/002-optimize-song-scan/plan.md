# Implementation Plan: 优化歌曲扫描机制

**Branch**: `002-optimize-song-scan` | **Date**: 2025-12-31 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/002-optimize-song-scan/spec.md`

**Note**: This plan was generated by the `/speckit.plan` command.

## Summary

优化本地音乐扫描机制：
1. 使用 `parseFile` 替代全文件缓冲读取，显著减少 IO 和内存使用
2. 重构数据模型，使用 `localPath` 作为主键，支持存储无 songId 的本地歌曲
3. 实现增量扫描，通过文件 mtime/size 检测变化，跳过未修改文件

## Technical Context

**Language/Version**: TypeScript 5.7 (Bun runtime)
**Primary Dependencies**: music-metadata ^10.6.4, commander ^13.1.0
**Storage**: JSON 文件 (~/.musync/database.json)
**Testing**: Bun test
**Target Platform**: Node.js/Bun CLI (Windows, macOS, Linux)
**Project Type**: Single CLI 项目
**Performance Goals**: 1000 文件扫描 < 10s，增量扫描 < 2s
**Constraints**: 内存峰值 < 200MB，支持 30GB+ 音乐库
**Scale/Scope**: 单用户 CLI 工具，目标支持 10k+ 文件

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

Constitution 文件为模板状态，无具体约束。本功能设计符合以下最佳实践：
- ✅ 保持 CLI 兼容性
- ✅ 支持 JSON 输出格式
- ✅ 不引入新的外部依赖

## Project Structure

### Documentation (this feature)

```text
specs/002-optimize-song-scan/
├── plan.md              # This file
├── research.md          # Phase 0 output - 技术研究
├── data-model.md        # Phase 1 output - 数据模型变更
├── quickstart.md        # Phase 1 output - 快速开始指南
├── contracts/           # Phase 1 output - API 契约
│   ├── cli.md          # CLI 命令契约
│   ├── database.md     # 数据库 API 契约
│   └── scanner.md      # Scanner 服务契约
└── tasks.md             # Phase 2 output (NOT created by /speckit.plan)
```

### Source Code (repository root)

```text
src/
├── models/
│   ├── config.ts       # 修改: SyncRecord 结构
│   └── local-track.ts  # 修改: LocalTrack 新增字段
├── services/
│   └── scanner.ts      # 修改: 使用 parseFile，增量扫描
├── storage/
│   └── database.ts     # 修改: localPath 主键，新增查询方法
├── commands/
│   └── scan.ts         # 修改: 存储所有歌曲，新增选项
└── utils/
    └── file.ts         # 可能修改: 新增文件统计工具
```

*Note: Test files not included as tests were not explicitly requested for this feature.*

**Structure Decision**: 保持现有单项目结构，修改现有模块而非创建新模块。

## Complexity Tracking

> 本功能无 Constitution 违规，无需记录复杂度权衡。
