# Feature Specification: 网易云音乐歌单同步应用

**Feature Branch**: `001-playlist-sync`  
**Created**: 2025-12-31  
**Status**: Draft  
**Input**: User description: "使用nodejs构建一个歌单同步应用，从网易云获取歌单数据，与本地歌曲对比，下载缺失歌曲，支持NCM解密和音质升级"

## 概述

本应用旨在帮助用户将网易云音乐的在线歌单与本地音乐库进行同步。用户可以自动下载歌单中缺失的歌曲，并在有更高音质版本可用时进行升级。

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 首次登录与认证 (Priority: P1)

作为一名网易云音乐用户，我希望能够安全地登录到我的账户，以便应用可以访问我的歌单数据。

**Why this priority**: 登录是使用所有功能的前提条件，没有认证就无法获取用户歌单。

**Independent Test**: 可以通过尝试登录并验证是否成功获取用户信息来独立测试。

**Acceptance Scenarios**:

1. **Given** 用户首次启动应用且未提供cookie, **When** 用户选择登录, **Then** 系统显示登录选项（手机号/邮箱/二维码）
2. **Given** 用户选择手机号登录, **When** 用户输入正确的手机号和密码, **Then** 系统成功登录并保存cookie凭证
3. **Given** 用户已有有效cookie, **When** 应用启动, **Then** 系统自动使用已保存的cookie进行认证
4. **Given** 已保存的cookie已过期, **When** 应用尝试使用该cookie, **Then** 系统提示用户重新登录

---

### User Story 2 - 获取并查看在线歌单 (Priority: P1)

作为用户，我希望能够查看我在网易云音乐上的所有歌单及其内容，以便选择要同步的歌单。

**Why this priority**: 这是同步功能的核心数据来源，必须先获取歌单才能进行后续对比和下载。

**Independent Test**: 登录后可以独立验证是否能成功获取并展示用户歌单列表。

**Acceptance Scenarios**:

1. **Given** 用户已成功登录, **When** 用户请求查看歌单列表, **Then** 系统显示用户所有歌单（包括创建的和收藏的）
2. **Given** 歌单列表已加载, **When** 用户选择某个歌单, **Then** 系统显示该歌单中的所有歌曲信息（歌名、歌手、专辑、时长）
3. **Given** 网络连接中断, **When** 用户尝试获取歌单, **Then** 系统显示友好的错误提示并建议重试

---

### User Story 3 - 扫描本地音乐库 (Priority: P1)

作为用户，我希望应用能够扫描我的本地音乐文件夹，识别已有的歌曲，以便与在线歌单进行对比。

**Why this priority**: 准确识别本地歌曲是避免重复下载和进行差异对比的基础。

**Independent Test**: 可以独立测试扫描功能，验证是否能正确识别本地歌曲文件。

**Acceptance Scenarios**:

1. **Given** 用户指定了本地音乐文件夹路径, **When** 应用扫描该文件夹, **Then** 系统识别所有支持格式的音频文件（mp3, flac, wav, ncm等）
2. **Given** 音频文件命名符合"歌名 - 歌手.后缀"格式, **When** 系统解析文件, **Then** 正确提取歌名和歌手信息
3. **Given** 音频文件命名不规范, **When** 系统解析文件, **Then** 系统尝试读取文件元数据（ID3标签）获取歌曲信息
4. **Given** 扫描完成, **When** 系统汇总结果, **Then** 显示本地歌曲总数及识别成功/失败的数量

---

### User Story 4 - 对比分析与差异报告 (Priority: P1)

作为用户，我希望看到在线歌单与本地音乐的差异，包括缺失的歌曲和可升级音质的歌曲。

**Why this priority**: 差异分析是用户决策下载的依据，是核心功能之一。

**Independent Test**: 给定歌单数据和本地歌曲列表，可以独立验证对比结果的准确性。

**Acceptance Scenarios**:

1. **Given** 在线歌单已加载且本地扫描完成, **When** 用户发起对比, **Then** 系统生成差异报告
2. **Given** 差异报告生成完成, **When** 用户查看报告, **Then** 报告清晰展示：缺失歌曲列表、可升级音质歌曲列表、已匹配歌曲列表
3. **Given** 本地存在同名但不同版本的歌曲, **When** 系统对比, **Then** 基于歌名+歌手的组合进行匹配判断

---

### User Story 5 - 下载缺失歌曲 (Priority: P2)

作为用户，我希望能够下载歌单中本地缺失的歌曲，以保持本地音乐库与在线歌单同步。

**Why this priority**: 这是应用的核心价值功能，但依赖于前面的登录、获取歌单和对比功能。

**Independent Test**: 可以选择下载单首歌曲来验证下载功能是否正常工作。

**Acceptance Scenarios**:

1. **Given** 差异报告显示缺失歌曲, **When** 用户选择下载全部或部分歌曲, **Then** 系统开始下载任务
2. **Given** 下载任务进行中, **When** 用户查看进度, **Then** 系统显示每首歌曲的下载进度和总体进度
3. **Given** 歌曲下载完成, **When** 系统保存文件, **Then** 文件按照"歌名 - 歌手.后缀"格式命名并保存到指定目录
4. **Given** 某首歌曲下载失败, **When** 系统记录错误, **Then** 继续下载其他歌曲并在最后汇总失败列表

---

### User Story 6 - 音质升级 (Priority: P2)

作为用户，当在线提供比本地更高音质的版本时，我希望能够选择升级本地歌曲。

**Why this priority**: 音质升级是增值功能，提升用户体验但非核心必需。

**Independent Test**: 可以选择单首有更高音质的歌曲进行升级测试。

**Acceptance Scenarios**:

1. **Given** 对比发现本地为mp3而在线有flac版本, **When** 系统标记该歌曲, **Then** 将其列入可升级列表
2. **Given** 用户选择升级某些歌曲, **When** 下载完成, **Then** 用户可选择保留或删除原有低音质文件
3. **Given** 升级后的歌曲保存成功, **When** 更新本地数据库, **Then** 记录新文件信息并更新音质标记

---

### User Story 7 - NCM文件解密 (Priority: P2)

作为用户，当下载的歌曲为NCM加密格式时，我希望应用能够自动解密为标准音频格式。

**Why this priority**: NCM是网易云特有格式，解密功能确保用户能在任何播放器中播放下载的歌曲。

**Independent Test**: 可以提供NCM文件测试解密功能是否正常。

**Acceptance Scenarios**:

1. **Given** 下载的文件为ncm格式, **When** 下载完成, **Then** 系统自动调用解密工具进行解密
2. **Given** 解密成功, **When** 系统处理文件, **Then** 生成标准格式文件（mp3/flac）并删除原ncm文件
3. **Given** 解密失败, **When** 系统记录错误, **Then** 保留原ncm文件并提示用户手动处理

---

### User Story 8 - 本地歌曲数据库管理 (Priority: P2)

作为用户，我希望应用维护一份本地数据库，记录已同步歌曲的元数据，以加快后续对比速度。

**Why this priority**: 数据库可以避免每次都重新扫描本地文件，提升用户体验。

**Independent Test**: 可以独立测试数据库的读写和查询功能。

**Acceptance Scenarios**:

1. **Given** 歌曲首次被识别或下载, **When** 系统记录信息, **Then** 保存歌曲ID、歌名、歌手、专辑、本地路径、音质等信息
2. **Given** 用户再次启动应用, **When** 加载数据库, **Then** 快速获取本地歌曲列表无需重新扫描
3. **Given** 本地文件被手动删除, **When** 系统检测到不一致, **Then** 更新数据库移除对应记录

---

### Edge Cases

- 当歌单中包含已下架或无版权歌曲时，系统应标记为不可下载并继续处理其他歌曲（diff报告中显示）
- 当本地文件名包含特殊字符时，系统应正确处理文件读写（T046处理）
- 当磁盘空间不足时，系统应在下载前检测并提示用户（T048处理）
- 当同一首歌在多个歌单中出现时，只需下载一次（diff去重处理）
- 当网络不稳定导致下载失败时，支持自动重试（T047重试机制）
- 当用户的歌单数量或歌曲数量非常大时，应分页加载避免内存溢出

## Requirements *(mandatory)*

### Functional Requirements

**认证模块**
- **FR-001**: 系统必须支持通过网易云音乐API进行用户认证
- **FR-002**: 系统必须安全存储用户cookie凭证，支持会话保持
- **FR-003**: 系统必须在cookie过期时自动提示用户重新登录

**歌单管理模块**
- **FR-004**: 系统必须能够获取用户创建的和收藏的所有歌单
- **FR-005**: 系统必须能够获取指定歌单的完整歌曲列表
- **FR-006**: 系统必须展示歌曲的基本信息（歌名、歌手、专辑、时长、音质）

**本地扫描模块**
- **FR-007**: 系统必须支持扫描用户指定的本地音乐文件夹
- **FR-008**: 系统必须支持mp3、flac、wav、ncm等常见音频格式
- **FR-009**: 系统必须优先使用文件名规则（歌名 - 歌手.后缀）解析歌曲信息
- **FR-010**: 系统必须在文件名解析失败时尝试读取音频文件元数据

**对比分析模块**
- **FR-011**: 系统必须能够对比在线歌单与本地音乐库的差异
- **FR-012**: 系统必须识别本地缺失的歌曲
- **FR-013**: 系统必须识别可升级音质的歌曲（如mp3->flac）
- **FR-014**: 系统必须生成清晰的差异报告供用户查看

**下载模块**
- **FR-015**: 系统必须能够通过API获取歌曲下载链接
- **FR-016**: 系统必须支持批量下载功能
- **FR-017**: 系统必须显示下载进度
- **FR-018**: 系统必须按照规范命名格式保存下载的歌曲
- **FR-019**: 系统必须处理下载失败的情况并提供重试机制

**NCM解密模块**
- **FR-020**: 系统必须能够识别NCM加密格式文件
- **FR-021**: 系统必须能够调用解密工具将NCM转换为标准格式
- **FR-022**: 系统必须在解密成功后清理原始NCM文件

**数据持久化模块**
- **FR-023**: 系统必须在本地维护歌曲元数据库，使用JSON文件格式存储
- **FR-024**: 数据库必须记录歌曲的在线ID、歌名、歌手、本地路径、音质等信息
- **FR-025**: 系统必须支持数据库的增删改查操作
- **FR-026**: 系统默认将配置和数据存储在 ~/.musync/ 目录
- **FR-027**: 系统必须支持通过启动参数指定自定义数据目录

**命令行接口模块**
- **FR-028**: 系统必须提供纯命令行参数接口，支持子命令模式（如 login, sync, scan）
- **FR-029**: 系统必须提供 --help 参数显示使用说明
- **FR-030**: 系统必须在命令执行过程中输出进度和结果信息到标准输出
- **FR-031**: 系统默认输出简洁日志，仅显示关键操作和结果
- **FR-032**: 系统必须支持 --verbose 参数启用详细日志输出，包含调试信息

### Key Entities

- **User（用户）**: 网易云音乐账户信息，包含用户ID、昵称、cookie凭证
- **Playlist（歌单）**: 歌单信息，包含歌单ID、名称、创建者、歌曲数量、歌曲列表
- **Song（歌曲）**: 歌曲信息，包含歌曲ID、歌名、歌手、专辑、时长、可用音质列表
- **LocalTrack（本地曲目）**: 本地文件信息，包含文件路径、解析出的歌名、歌手、音质、关联的在线歌曲ID
- **SyncRecord（同步记录）**: 同步状态记录，包含歌曲ID、同步时间、同步状态、本地路径

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用户可以在30秒内完成登录流程
- **SC-002**: 系统可以在10秒内加载包含1000首歌曲的歌单
- **SC-003**: 本地扫描1000首歌曲的文件夹应在30秒内完成
- **SC-004**: 歌曲匹配准确率达到95%以上（基于歌名+歌手匹配）
- **SC-005**: 下载功能支持同时处理至少5个并发下载任务
- **SC-006**: NCM文件解密成功率达到99%以上
- **SC-007**: 应用可以稳定处理包含10个歌单、总计5000首歌曲的同步任务
- **SC-008**: 差异对比完成后，用户可以在3个命令内开始下载缺失歌曲

## Clarifications

### Session 2025-12-31

- Q: NeteaseCloudMusicApi部署方式？ → A: 作为内置模块集成到应用中（启动时自动启动API服务）
- Q: 配置数据存储位置？ → A: 默认 ~/.musync/，允许启动时指定自定义数据目录
- Q: CLI交互模式？ → A: 纯命令行参数模式（如 musync sync --playlist "我喜欢"）
- Q: 本地数据库存储格式？ → A: JSON文件（简单直接，易于调试和手动编辑）
- Q: 日志与错误输出级别？ → A: 分级输出，默认简洁，支持 --verbose 显示详细日志

## Assumptions

1. 用户拥有有效的网易云音乐账户
2. 用户有合法的音乐下载权限（如VIP会员或歌曲本身免费）
3. NeteaseCloudMusicApiEnhanced 作为 npm 依赖集成，支持歌曲解灰功能
4. NCM解密使用纯JavaScript实现，无需外部工具
5. 用户的本地音乐文件主要使用"歌名 - 歌手.后缀"命名规范
6. 用户有足够的磁盘空间存储下载的音乐文件

## Out of Scope（不在本期范围内）

- 图形用户界面（GUI）- 属于未来扩展
- 终端交互界面（TUI）- 属于未来扩展
- 断点续传（下载中断后从断点继续）- 当前使用重试机制替代
- 歌词同步下载
- 专辑封面下载
- 其他音乐平台支持（如QQ音乐、Spotify）
- 音乐播放功能
- 自动定时同步功能
